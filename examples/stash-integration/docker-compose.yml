version: '3.8'

services:
  # Erin with integrated Stash Middleware
  erin:
    image: ghcr.io/oppositeodd/erin-stash:latest
    container_name: erin
    depends_on:
      stash:
        condition: service_healthy
    ports:
      # Erin web interface
      - "3000:80"
      # Stash middleware API
      - "3001:3001"
    environment:
      # ==================================================
      # ERIN CONFIGURATION
      # ==================================================
      # These variables configure the Erin React application
      
      # Scroll direction for video feed
      SCROLL_DIRECTION: ${SCROLL_DIRECTION:-vertical}
      
      # Whether videos should autoplay when scrolled into view
      AUTOPLAY_ENABLED: ${AUTOPLAY_ENABLED:-true}
      
      # Position of the video progress bar (top or bottom)
      PROGRESS_BAR_POSITION: ${PROGRESS_BAR_POSITION:-top}
      
      # Skip videos in hidden directories (starting with .)
      IGNORE_HIDDEN_PATHS: ${IGNORE_HIDDEN_PATHS:-true}
      
      # ==================================================
      # STASH MIDDLEWARE CONFIGURATION
      # ==================================================
      # Full URL to your Stash server
      STASH_URL: ${STASH_URL}
      
      # API key for Stash authentication (optional)
      STASH_API_KEY: ${STASH_API_KEY:-}
      
      # Comma-separated list of Stash group names (each becomes a playlist)
      GROUP_NAMES: ${GROUP_NAMES:-Erin}
      
      # Port for middleware API (internal, mapped to 3001 externally)
      MIDDLEWARE_PORT: 3001
    restart: unless-stopped
    networks:
      - erin-network

  # Stash server (comment out if using external Stash instance)
  stash:
    image: stashapp/stash:latest
    container_name: stash
    restart: unless-stopped
    environment:
      - STASH_STASH=/data
      - STASH_GENERATED=/generated
      - STASH_METADATA=/metadata
      - STASH_CACHE=/cache
      - STASH_PORT=9999
    ports:
      - "9999:9999"
    volumes:
      - ${STASH_CONFIG_PATH:-./stash-config}:/root/.stash
      - ${MEDIA_PATH:-/path/to/media}:/data
      - stash-generated:/generated
      - stash-metadata:/metadata
      - stash-cache:/cache
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9999/graphql"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - erin-network

volumes:
  stash-generated:
  stash-metadata:
  stash-cache:

networks:
  erin-network:
    driver: bridge

# ==================================================
# USAGE INSTRUCTIONS
# ==================================================
#
# This docker-compose includes both Erin and Stash.
# If you already have Stash running elsewhere, comment out the 'stash' service
# and remove the 'depends_on' section from the 'erin' service.
#
# 1. Copy this file to your deployment location
# 2. Create a .env file with your configuration:
#
#    STASH_URL=http://stash:9999  # Use 'stash' for container name or IP for external
#    GROUP_NAMES=Erin,Favorites,New Releases
#
# 3. Run: docker-compose up -d
# 4. Access Erin at: http://localhost:3000
#
# ==================================================
# ENVIRONMENT VARIABLES REFERENCE
# ==================================================
#
# Required:
#   STASH_URL              - URL to Stash server (e.g., http://192.168.1.75:9999)
#
# Recommended:
#   GROUP_NAMES            - Comma-separated Stash groups (e.g., Erin,Favorites)
#
# Optional:
#   STASH_API_KEY          - Stash API key (if authentication required)
#   SCROLL_DIRECTION       - vertical or horizontal (default: vertical)
#   AUTOPLAY_ENABLED       - true or false (default: true)
#   PROGRESS_BAR_POSITION  - top or bottom (default: top)
#   IGNORE_HIDDEN_PATHS    - true or false (default: true)
#
# ==================================================
# PORTS
# ==================================================
#
#   3000 - Erin web interface
#   3001 - Stash middleware API (internal communication)
#
# ==================================================
# VOLUMES
# ==================================================
#
# No volume mounts needed! Videos stream directly from Stash.
#
# ==================================================
